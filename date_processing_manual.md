# Инструкция по внедрению поддержки дат в Excel Mail Processor v8.1

## Обзор изменений

Версия v8.1 добавляет полную поддержку обработки колонок с датами, обеспечивая корректное форматирование дат согласно заданным параметрам в инструкциях OneDrive.

## Пошаговая инструкция по внедрению

### Шаг 1: Обновление файлов кода

1. **Замените excel_processor_v8.py на excel_processor_v8_1.py**
   ```bash
   cd /path/to/your/project
   cp excel_processor_v8.py excel_processor_v8_backup.py  # Резервная копия
   cp excel_processor_v8_1.py excel_processor_v8.py
   ```

2. **Замените onedrive_handler_v8.py на onedrive_handler_v8_1.py**
   ```bash
   cp onedrive_handler_v8.py onedrive_handler_v8_backup.py  # Резервная копия
   cp onedrive_handler_v8_1.py onedrive_handler_v8.py
   ```

### Шаг 2: Обновление файла инструкций на OneDrive

#### Структура обновленного листа 'columns' в FGK.xlsx

Добавьте следующие колонки к существующему листу 'columns':

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| source_name | target_name | action | value | is_date | date_format | date_locale |
| Дата_отправления | Дата отправления | copy | | TRUE | DD.MM.YYYY | ru |
| Время_прибытия | Время прибытия | copy | | TRUE | DD MMM YYYY | ru |
| CreateDate | Дата создания | copy | | TRUE | YYYY-MM-DD | en |
| Обычная_колонка | Обычная колонка | copy | | FALSE | | |

#### Описание новых колонок:

- **E (is_date)**: TRUE/FALSE - указывает, что колонка содержит даты
- **F (date_format)**: формат вывода даты (обязательно для is_date=TRUE)
- **G (date_locale)**: локаль для названий месяцев (опционально, по умолчанию 'ru')

### Шаг 3: Поддерживаемые форматы дат

#### Доступные форматы:

1. **DD.MM.YYYY** → 15.06.2025
2. **DD/MM/YYYY** → 15/06/2025
3. **DD-MM-YYYY** → 15-06-2025
4. **YYYY-MM-DD** → 2025-06-15
5. **MM/DD/YYYY** → 06/15/2025
6. **DD MMM YYYY** → 15 июн 2025
7. **DD MMMM YYYY** → 15 июня 2025

#### Доступные локали:

- **ru** - русские названия месяцев (янв, фев, март, ... / января, февраля, ...)
- **en** - английские названия месяцев (Jan, Feb, Mar, ... / January, February, ...)

### Шаг 4: Примеры конфигурации

#### Пример 1: Базовое форматирование дат
```
source_name: ДатаОтгрузки
target_name: Дата отгрузки
action: copy
value: 
is_date: TRUE
date_format: DD.MM.YYYY
date_locale: ru
```

#### Пример 2: Даты с русскими названиями месяцев
```
source_name: ShipDate
target_name: Дата отправки
action: copy
value:
is_date: TRUE
date_format: DD MMMM YYYY
date_locale: ru
```

#### Пример 3: Международный формат
```
source_name: CreatedDate
target_name: Created
action: copy
value:
is_date: TRUE
date_format: YYYY-MM-DD
date_locale: en
```

### Шаг 5: Тестирование изменений

1. **Проверьте конфигурацию**
   ```bash
   python main.py --test
   ```

2. **Запустите обработку тестового файла**
   ```bash
   python main.py
   ```

3. **Проверьте логи на наличие сообщений о форматировании дат**
   ```bash
   tail -f logs/excel_processor.log | grep "дат"
   ```

### Шаг 6: Мониторинг работы

#### Новые логи v8.1:

- `✅ Настроена колонка с датами: 'source' -> 'target' (DD.MM.YYYY, ru)`
- `✅ Отформатировано N дат в формате DD.MM.YYYY`
- `✅ Отформатировано колонок с датами: N`

#### Расширенная статистика:

В email уведомлениях теперь доступна переменная `{formatted_date_columns}` для подстановки количества отформатированных колонок с датами.

## Обратная совместимость

- Все существующие настройки продолжают работать без изменений
- Колонки без параметра `is_date` или с `is_date=FALSE` обрабатываются как раньше
- Новые параметры опциональны для существующих конфигураций

## Устранение неполадок

### Проблема: Даты отображаются как числа

**Решение**: Убедитесь, что:
1. Параметр `is_date` установлен в TRUE
2. Параметр `date_format` указан корректно
3. Исходная колонка действительно содержит даты

### Проблема: Неправильный формат дат

**Решение**: Проверьте:
1. Корректность формата в `date_format`
2. Соответствие локали в `date_locale`
3. Логи обработки на предмет ошибок парсинга дат

### Проблема: Ошибки при загрузке инструкций

**Решение**: 
1. Проверьте структуру листа 'columns' в Excel
2. Убедитесь, что новые колонки добавлены правильно
3. Проверьте формат данных (TRUE/FALSE для is_date)

## Логика работы системы

### Алгоритм обработки дат:

1. **Парсинг инструкций**: OneDriveHandler загружает расширенные настройки колонок
2. **Идентификация дат**: Система определяет колонки с `is_date=TRUE`
3. **Копирование данных**: Данные копируются из исходной колонки
4. **Форматирование**: Применяется метод `_format_date_column()` с заданными параметрами
5. **Валидация**: Проверка корректности результата форматирования
6. **Статистика**: Подсчет успешно отформатированных колонок

### Обработка ошибок:

- При ошибке парсинга даты возвращается исходное значение
- Некорректные форматы дат логируются как предупреждения
- Система продолжает работу даже при ошибках в отдельных ячейках

## Заключение

Обновление v8.1 обеспечивает полную поддержку корректной обработки дат без нарушения существующей логики системы. Все изменения обратно совместимы и могут быть внедрены поэтапно.